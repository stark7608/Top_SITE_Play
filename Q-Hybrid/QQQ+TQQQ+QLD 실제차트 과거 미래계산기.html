<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Hybrid ë§ˆìŠ¤í„° ê³„ì‚°ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1e3a8a; --bg: #f8fafc; --card: #fff; --border: #cbd5e1;
            --accent: #f59e0b; --success: #10b981; --danger: #ef4444; --text: #334155;
        }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); padding: 20px; color: var(--text); margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }

        /* ì…ë ¥ íŒ¨ë„ */
        .input-panel { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; }
        h2 { margin-top: 0; font-size: 1.3rem; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        
        /* [ì¶”ê°€] ì½”ë© ê°€ì´ë“œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .guide-box { background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 10px; margin-bottom: 25px; }
        .guide-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .guide-title { font-weight: bold; color: #1e40af; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .colab-link { background-color: #2563eb; color: white; text-decoration: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .colab-link:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .code-wrapper { position: relative; background: #1e293b; border-radius: 8px; overflow: hidden; border: 1px solid #475569; }
        .code-content { color: #e2e8f0; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; padding: 15px; margin: 0; white-space: pre; overflow-x: auto; line-height: 1.5; }
        .copy-button { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: 0.2s; }
        .copy-button:hover { background: rgba(255,255,255,0.3); }

        .section-title { font-size: 0.85rem; font-weight: 700; color: #64748b; margin: 25px 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; border-left: 3px solid var(--accent); padding-left: 10px; }

        /* ì „ëµ ì„ íƒ */
        .strat-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .strat-btn { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #f1f5f9; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.2s; }
        .strat-btn.active-1 { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 5px rgba(245,158,11,0.3); }
        .strat-btn.active-2 { background: var(--success); color: white; border-color: var(--success); box-shadow: 0 2px 5px rgba(16,185,129,0.3); }

        /* íŒŒì¼ ì—…ë¡œë“œ ê·¸ë£¹ */
        .file-group { display: flex; flex-direction: column; gap: 8px; }
        .file-row { display: flex; align-items: center; gap: 10px; }
        .file-label { font-size: 0.9rem; font-weight: bold; width: 50px; }
        .file-input-box { flex: 1; position: relative; overflow: hidden; background: #f8fafc; border: 1px solid var(--border); border-radius: 6px; padding: 8px; cursor: pointer; font-size: 0.8rem; color: #94a3b8; text-align: center; transition: 0.2s; }
        .file-input-box input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .file-input-box.done { background: #ecfdf5; color: #059669; border-color: #10b981; font-weight: bold; }

        /* í¼ ì…ë ¥ */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; }
        .input-wrapper { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 8px; background: #fff; overflow: hidden; }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1); }
        .input-wrapper input { flex: 1; border: none; padding: 10px; font-size: 1rem; text-align: right; outline: none; width: 100%; }
        .input-wrapper .unit { padding: 0 12px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; font-weight: 600; border-left: 1px solid var(--border); display: flex; align-items: center; height: 100%; }

        /* ë‚ ì§œ ì…ë ¥ (ì—°.ì›”.ì¼) */
        .date-inputs { display: flex; gap: 5px; align-items: center; }
        .date-input { text-align: center; border: 1px solid var(--border); padding: 10px; border-radius: 6px; font-size: 1rem; outline: none; }
        .date-input:focus { border-color: var(--primary); }
        .date-sep { font-weight: bold; color: #cbd5e1; }
        .y-input { width: 60px; } .m-input { width: 40px; } .d-input { width: 40px; }

        /* ë²„íŠ¼ */
        .calc-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .calc-btn:hover { background: #1e40af; transform: translateY(-1px); }
        .calc-btn:disabled { background: #94a3b8; cursor: not-allowed; }

        /* ê²°ê³¼ íŒ¨ë„ */
        .result-panel { display: flex; flex-direction: column; gap: 20px; }
        .score-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-label { font-size: 0.9rem; color: #64748b; margin-bottom: 5px; }
        .card-value { font-size: 1.3rem; font-weight: 800; color: var(--text); }

        .chart-container { background: var(--card); padding: 20px; border-radius: 16px; height: 450px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .log-container { background: var(--card); padding: 20px; border-radius: 16px; max-height: 250px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .log-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; display: flex; justify-content: space-between; }

        /* ì˜ˆì¸¡ ì •ë³´ ë°•ìŠ¤ */
        .forecast-info { background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; font-size: 0.9rem; color: #1e40af; margin-top: 15px; display: none; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .score-cards { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <!-- ì™¼ìª½ ì…ë ¥ íŒ¨ë„ -->
    <div class="input-panel">
        <h2>ğŸ›  ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h2>

        <!-- [ì¶”ê°€] ì½”ë© ê°€ì´ë“œ ë°•ìŠ¤ -->
        <div class="guide-box">
            <div class="guide-header">
                <div class="guide-title">ğŸ’¡ ë°ì´í„° ìƒì„± ê°€ì´ë“œ (Google Colab)</div>
                <a href="https://colab.research.google.com/#create=true" target="_blank" class="colab-link">ğŸš€ ì½”ë© ì—´ê¸°</a>
            </div>
            <div class="code-wrapper">
                <button class="copy-button" onclick="copyCode()">ì½”ë“œ ë³µì‚¬</button>
<div class="code-content" id="pythonCode">import yfinance as yf

print("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.")

# 1. QQQ ë‹¤ìš´ë¡œë“œ
yf.download("QQQ", period="max", progress=False).to_csv("QQQ.csv")

# 2. TQQQ ë‹¤ìš´ë¡œë“œ
yf.download("TQQQ", period="max", progress=False).to_csv("TQQQ.csv")

# 3. QLD ë‹¤ìš´ë¡œë“œ (ì¶”ê°€ëœ ë¶€ë¶„)
yf.download("QLD", period="max", progress=False).to_csv("QLD.csv")

print("âœ… ì™„ë£Œ! ì™¼ìª½ í´ë”(ğŸ“) ì•„ì´ì½˜ì„ ëˆŒëŸ¬ QQQ, TQQQ, QLD íŒŒì¼ì„ ëª¨ë‘ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.")</div>
            </div>
        </div>

        <div class="section-title">1. ì „ëµ ì„ íƒ</div>
        <div class="strat-selector">
            <div class="strat-btn active-1" id="btnStrat1" onclick="setStrategy(1)">ì „ëµ 1 (Switching)</div>
            <div class="strat-btn" id="btnStrat2" onclick="setStrategy(2)">ì „ëµ 2 (Hybrid)</div>
        </div>

        <div class="section-title">2. ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ</div>
        <div class="file-group">
            <div class="file-row">
                <span class="file-label">QQQ</span>
                <div class="file-input-box" id="boxQQQ">
                    <span id="txtQQQ">íŒŒì¼ ì„ íƒ (.csv)</span>
                    <input type="file" accept=".csv" onchange="handleFile(this, 'QQQ')">
                </div>
            </div>
            <div class="file-row">
                <span class="file-label">TQQQ</span>
                <div class="file-input-box" id="boxTQQQ">
                    <span id="txtTQQQ">íŒŒì¼ ì„ íƒ (.csv)</span>
                    <input type="file" accept=".csv" onchange="handleFile(this, 'TQQQ')">
                </div>
            </div>
            <div class="file-row">
                <span class="file-label">QLD</span>
                <div class="file-input-box" id="boxQLD">
                    <span id="txtQLD">íŒŒì¼ ì„ íƒ (.csv)</span>
                    <input type="file" accept=".csv" onchange="handleFile(this, 'QLD')">
                </div>
            </div>
        </div>

        <div class="section-title">3. íˆ¬ì ê¸°ê°„ (ê³¼ê±° ~ ë¯¸ë˜)</div>
        <div class="form-group">
            <label>ì‹œì‘ì¼</label>
            <div class="date-inputs">
                <input type="text" class="date-input y-input" id="sY" placeholder="YYYY" maxlength="4" oninput="autoTab(this, 'sM')">
                <span class="date-sep">.</span>
                <input type="text" class="date-input m-input" id="sM" placeholder="MM" maxlength="2" oninput="autoTab(this, 'sD')">
                <span class="date-sep">.</span>
                <input type="text" class="date-input d-input" id="sD" placeholder="DD" maxlength="2" oninput="autoTab(this, 'eY')">
            </div>
        </div>
        <div class="form-group">
            <label>ì¢…ë£Œì¼ (ë¯¸ë˜ ì…ë ¥ ì‹œ ì˜ˆì¸¡)</label>
            <div class="date-inputs">
                <input type="text" class="date-input y-input" id="eY" placeholder="YYYY" maxlength="4" oninput="autoTab(this, 'eM')">
                <span class="date-sep">.</span>
                <input type="text" class="date-input m-input" id="eM" placeholder="MM" maxlength="2" oninput="autoTab(this, 'eD')">
                <span class="date-sep">.</span>
                <input type="text" class="date-input d-input" id="eD" placeholder="DD" maxlength="2">
            </div>
        </div>

        <div class="section-title">4. ìê¸ˆ ì„¤ì •</div>
        <div class="form-group">
            <label>ì´ˆê¸° íˆ¬ìê¸ˆ</label>
            <div class="input-wrapper">
                <input type="text" id="initCapital" value="10,000,000" onkeyup="formatComma(this)">
                <span class="unit">KRW</span>
            </div>
        </div>
        <div class="form-group">
            <label>ë§¤ì›” ì ë¦½ê¸ˆ</label>
            <div class="input-wrapper">
                <input type="text" id="monthlyDeposit" value="200,000" onkeyup="formatComma(this)">
                <span class="unit">KRW</span>
            </div>
        </div>
        <div class="form-group">
            <label>í™˜ìœ¨</label>
            <div class="input-wrapper">
                <input type="text" id="exchangeRate" value="1,400" onkeyup="formatComma(this)">
                <span class="unit">ì›/$</span>
            </div>
        </div>

        <div class="section-title">5. ì „ëµ ìƒì„¸</div>
        <div class="form-group">
            <label>í•˜ë½ ìŠ¤ìœ„ì¹­ ê¸°ì¤€ (ì „ê³ ì  ëŒ€ë¹„)</label>
            <div class="input-wrapper">
                <input type="number" id="dropTrigger" value="-25">
                <span class="unit">%</span>
            </div>
        </div>
        <div class="form-group">
            <label>ìµì ˆ ê¸°ì¤€ (ì§ì „ ê³ ì  ëŒ€ë¹„)</label>
            <div class="input-wrapper">
                <input type="number" id="targetReturn" value="10">
                <span class="unit">%</span>
            </div>
        </div>

        <button class="calc-btn" id="btnRun" onclick="runAnalysis()" disabled>ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ê²°ê³¼ íŒ¨ë„ -->
    <div class="result-panel">
        <!-- ì˜ˆì¸¡ ëª¨ë“œì¼ ë•Œ ì•ˆë‚´ -->
        <div class="forecast-info" id="forecastInfo">
            <strong>ğŸ”® ë¯¸ë˜ ì˜ˆì¸¡ ëª¨ë“œ í™œì„±í™”</strong><br>
            ì…ë ¥í•˜ì‹  ì¢…ë£Œì¼ì´ ë°ì´í„° ë²”ìœ„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.<br>
            ê³¼ê±° ë°ì´í„°ì—ì„œ ì‚°ì¶œëœ <strong>ì—°í‰ê·  ì„±ì¥ë¥ (CAGR)</strong>ì„ ë°”íƒ•ìœ¼ë¡œ ë¯¸ë˜ ìˆ˜ìµì„ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
        </div>

        <div class="score-cards">
            <div class="card">
                <div class="card-label">ì´ íˆ¬ì ì›ê¸ˆ</div>
                <div class="card-value" id="resPrincipal">0 ì›</div>
            </div>
            <div class="card">
                <div class="card-label">ìµœì¢… í‰ê°€ì•¡</div>
                <div class="card-value" id="resFinal" style="color: var(--primary);">0 ì›</div>
            </div>
            <div class="card">
                <div class="card-label">ì´ ìˆ˜ìµë¥ </div>
                <div class="card-value" id="resYield">0.0 %</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="log-container">
            <div id="logList"></div>
        </div>
    </div>
</div>

<script>
    // --- ì „ì—­ ë³€ìˆ˜ ---
    const files = { QQQ: null, TQQQ: null, QLD: null };
    let mergedData = []; // { date: Date, qqq, tqqq, qld }
    let currentStrat = 1;
    let chartInstance = null;

    // --- UI ìœ í‹¸ë¦¬í‹° ---
    function copyCode() {
        const code = document.getElementById('pythonCode').innerText;
        navigator.clipboard.writeText(code).then(() => alert("ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }
    function formatComma(input) {
        let val = input.value.replace(/,/g, '');
        if(!isNaN(val) && val !== '') input.value = Number(val).toLocaleString();
    }
    function getNum(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
    function autoTab(el, nextId) {
        if(el.value.length >= el.getAttribute('maxlength')) document.getElementById(nextId).focus();
    }
    function setStrategy(type) {
        currentStrat = type;
        document.getElementById('btnStrat1').className = type === 1 ? 'strat-btn active-1' : 'strat-btn';
        document.getElementById('btnStrat2').className = type === 2 ? 'strat-btn active-2' : 'strat-btn';
    }

    // --- íŒŒì¼ ì²˜ë¦¬ ---
    function handleFile(input, type) {
        const file = input.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => {
                files[type] = parseCSV(e.target.result);
                document.getElementById('txt'+type).innerText = `âœ… ${type} ë¡œë“œë¨`;
                document.getElementById('box'+type).classList.add('done');
                checkFilesReady();
            };
            reader.readAsText(file);
        }
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const data = [];
        // ë‚ ì§œ(YYYY-MM-DD) ì°¾ê¸° ì •ê·œì‹
        const dateRegex = /(\d{4}-\d{2}-\d{2})/;
        
        lines.forEach(line => {
            const match = line.match(dateRegex);
            if(match) {
                const dateStr = match[1];
                const parts = line.split(',');
                // ê°€ê²© ì¶”ì¶œ (ìˆ«ìì¸ í•­ëª© ì¤‘ ì ì ˆí•œ ê°’, ë³´í†µ Close)
                const nums = parts.map(p => parseFloat(p)).filter(n => !isNaN(n));
                // ì•¼í›„ ë°ì´í„°: Date, Open, High, Low, Close, Adj Close, Vol
                // Adj Closeê°€ ìˆìœ¼ë©´(6ë²ˆì§¸, idx 5) ì¢‹ì§€ë§Œ, ë³´í†µ 4ë²ˆì§¸(Close)ë¥¼ ì”€
                // ì—¬ê¸°ì„  nums ë°°ì—´ ë’¤ìª½ ê°’ì„ ì”€ (Close or Adj Close)
                // numsê°€ [Open, High, Low, Close, AdjClose, Vol] ë¼ë©´ length 6
                let price = nums.length >= 4 ? nums[3] : nums[nums.length-1];
                if(price) data.push({ date: dateStr, price: price });
            }
        });
        return data;
    }

    function checkFilesReady() {
        if(files.QQQ && files.TQQQ && files.QLD) {
            document.getElementById('btnRun').disabled = false;
            document.getElementById('btnRun').innerText = "ë°ì´í„° ë¶„ì„ ë° ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰";
            
            // ë°ì´í„° ë³‘í•© (êµì§‘í•© ë‚ ì§œë§Œ)
            mergeData();
        }
    }

    function mergeData() {
        const mapT = new Map(files.TQQQ.map(d => [d.date, d.price]));
        const mapL = new Map(files.QLD.map(d => [d.date, d.price]));
        mergedData = [];

        files.QQQ.forEach(q => {
            if(mapT.has(q.date) && mapL.has(q.date)) {
                const parts = q.date.split('-');
                mergedData.push({
                    dateObj: new Date(parts[0], parts[1]-1, parts[2]),
                    dateStr: q.date,
                    qqq: q.price,
                    tqqq: mapT.get(q.date),
                    qld: mapL.get(q.date)
                });
            }
        });
        mergedData.sort((a, b) => a.dateObj - b.dateObj);
        
        // ê¸°ë³¸ ë‚ ì§œ ì„¸íŒ…
        if(mergedData.length > 0) {
            const s = mergedData[0].dateObj;
            const e = mergedData[mergedData.length-1].dateObj;
            document.getElementById('sY').value = s.getFullYear();
            document.getElementById('sM').value = String(s.getMonth()+1).padStart(2,'0');
            document.getElementById('sD').value = String(s.getDate()).padStart(2,'0');
            document.getElementById('eY').value = e.getFullYear();
            document.getElementById('eM').value = String(e.getMonth()+1).padStart(2,'0');
            document.getElementById('eD').value = String(e.getDate()).padStart(2,'0');
        }
    }

    // --- ë¶„ì„ ì‹¤í–‰ ---
    function runAnalysis() {
        // 1. ë‚ ì§œ íŒŒì‹±
        const sDate = new Date(getNum('sY'), getNum('sM')-1, getNum('sD'));
        const eDate = new Date(getNum('eY'), getNum('eM')-1, getNum('eD'));
        
        // 2. ê³¼ê±° ë°ì´í„° í•„í„°ë§
        let simData = mergedData.filter(d => d.dateObj >= sDate);
        if(simData.length === 0) { alert("ì‹œì‘ì¼ ì´í›„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        // ë§ˆì§€ë§‰ ì‹¤ì œ ë°ì´í„° ë‚ ì§œ
        const lastRealDate = mergedData[mergedData.length-1].dateObj;
        const isFuture = eDate > lastRealDate;
        
        // 3. ë¯¸ë˜ ì˜ˆì¸¡ ë°ì´í„° ìƒì„± (í•„ìš”ì‹œ)
        if(isFuture) {
            document.getElementById('forecastInfo').style.display = 'block';
            // ì—°í‰ê·  ì„±ì¥ë¥ (CAGR) ë° ì¼ì¼ ë³€ë™ì„± ê³„ì‚° (QQQ ê¸°ì¤€)
            const startP = simData[0].qqq;
            const endP = simData[simData.length-1].qqq;
            const days = (simData[simData.length-1].dateObj - simData[0].dateObj) / (1000*3600*24);
            const years = days / 365;
            
            // ì¼í‰ê·  ì„±ì¥ë¥  (ë‹¨ìˆœí™”)
            const dailyGrowthQQQ = Math.pow(endP / startP, 1/days) - 1; 
            
            // ë¯¸ë˜ ë°ì´í„° ìƒì„± loop
            let currDate = new Date(lastRealDate);
            let lastQQQ = endP;
            let lastTQQQ = simData[simData.length-1].tqqq;
            let lastQLD = simData[simData.length-1].qld;

            while(currDate < eDate) {
                currDate.setDate(currDate.getDate() + 1); // í•˜ë£¨ì”© ì¦ê°€
                if(currDate.getDay() === 0 || currDate.getDay() === 6) continue; // ì£¼ë§ ì œì™¸

                // QQQ ì„±ì¥ (ê³¼ê±° í‰ê·  ë°˜ì˜)
                lastQQQ = lastQQQ * (1 + dailyGrowthQQQ);
                // TQQQ, QLDëŠ” ë ˆë²„ë¦¬ì§€ ë°°ìˆ˜ ì ìš© (ë‹¨ìˆœ 3ë°°/2ë°° ê°€ì •)
                lastTQQQ = lastTQQQ * (1 + dailyGrowthQQQ * 3);
                lastQLD = lastQLD * (1 + dailyGrowthQQQ * 2);

                simData.push({
                    dateObj: new Date(currDate),
                    dateStr: currDate.toISOString().split('T')[0] + " (E)",
                    qqq: lastQQQ,
                    tqqq: lastTQQQ,
                    qld: lastQLD,
                    isForecast: true
                });
            }
        } else {
            document.getElementById('forecastInfo').style.display = 'none';
            // ì¢…ë£Œì¼ê¹Œì§€ë§Œ ìë¥´ê¸°
            simData = simData.filter(d => d.dateObj <= eDate);
        }

        // 4. ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
        simulate(simData);
    }

    function simulate(data) {
        const initCapKRW = getNum('initCapital');
        const monthlyKRW = getNum('monthlyDeposit');
        const exRate = getNum('exchangeRate');
        const dropTrigger = getNum('dropTrigger') / 100; // ìŒìˆ˜ê°’ (ì˜ˆ: -0.25)
        const targetReturn = getNum('targetReturn') / 100;

        // ë‹¬ëŸ¬ í™˜ì‚°
        let cashUSD = 0;
        let shares = { QQQ: 0, TQQQ: 0, QLD: 0 }; // ë³´ìœ  ìˆ˜ëŸ‰
        let totalPrincipalKRW = initCapKRW;

        // ì´ˆê¸° ë§¤ìˆ˜
        let initialUSD = initCapKRW / exRate;
        
        // ì „ëµ ë³€ìˆ˜
        let mode = 'NORMAL'; // NORMAL or ATTACK
        let lockedATH = 0; // í•˜ë½ ì§ì „ ê³ ì 
        let logs = [];
        let history = []; // { date, equityKRW }
        let ath = 0; // ì‹œë®¬ë ˆì´ì…˜ ë‚´ ATH ì¶”ì 

        // ì´ˆê¸° í¬ì§€ì…˜ ì„¤ì •
        if(currentStrat === 1) {
            // QQQ 100%
            shares.QQQ = initialUSD / data[0].qqq;
            logs.push(`[ì‹œì‘] ì´ˆê¸°ìê¸ˆìœ¼ë¡œ QQQ ë§¤ìˆ˜ ($${data[0].qqq.toFixed(2)})`);
        } else {
            // QLD 50%, Cash 50%
            shares.QLD = (initialUSD * 0.5) / data[0].qld;
            cashUSD = initialUSD * 0.5;
            logs.push(`[ì‹œì‘] ì´ˆê¸°ìê¸ˆ ë¶„ì‚°: QLD 50% / í˜„ê¸ˆ 50%`);
        }
        ath = data[0].qqq;

        // ë£¨í”„
        let lastMonth = -1;
        
        for(let i=0; i<data.length; i++) {
            const day = data[i];
            
            // ATH ë° MDD ê°±ì‹ 
            if(day.qqq > ath) {
                // ë³µê·€ í›„ ì‹ ê³ ê°€ ê°±ì‹  ì‹œì—ë§Œ ATH ì—…ë°ì´íŠ¸ (í•˜ë½ ì¤‘ì—” ì—…ë°ì´íŠ¸ ì•ˆí•¨ - ì „ëµ ë¡œì§ìš©)
                // ë‹¨ìˆœí•˜ê²ŒëŠ” í•­ìƒ ê°±ì‹ í•˜ë˜, ìŠ¤ìœ„ì¹­ ì‹œì ì˜ ATHë¥¼ ë³„ë„ ì €ì¥(lockedATH)
                ath = day.qqq; 
            }
            
            // ìŠ¤ìœ„ì¹­ ê¸°ì¤€ì€ 'ì§ì „ ê³ ì ' ëŒ€ë¹„ í•˜ë½. 
            // ê°€ì¥ ë†’ì€ ATHë¥¼ ê¸°ì¤€ìœ¼ë¡œ í• ì§€, ë¡œì»¬ ê³ ì ì„ ê¸°ì¤€ìœ¼ë¡œ í• ì§€ëŠ” ì„ íƒì´ë‚˜ 
            // ë³´í†µ MDDëŠ” ì—­ì‚¬ì  ê³ ì  ëŒ€ë¹„ì…ë‹ˆë‹¤.
            let mdd = (day.qqq / ath) - 1;

            // ì›” ì ë¦½ (ë§¤ì›” 1ì¼ í˜¹ì€ ì²« ê±°ë˜ì¼)
            if(day.dateObj.getMonth() !== lastMonth && i > 0) {
                lastMonth = day.dateObj.getMonth();
                totalPrincipalKRW += monthlyKRW;
                let depositUSD = monthlyKRW / exRate;

                if(currentStrat === 1) {
                    // ì „ëµ 1 ì ë¦½: í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë§¤ìˆ˜
                    if(mode === 'NORMAL') shares.QQQ += depositUSD / day.qqq;
                    else shares.TQQQ += depositUSD / day.tqqq;
                } else {
                    // ì „ëµ 2 ì ë¦½
                    if(mode === 'NORMAL') {
                        // 5:5 ë¶„ë°°
                        shares.QLD += (depositUSD * 0.5) / day.qld;
                        cashUSD += (depositUSD * 0.5);
                    } else {
                        // ê³µê²©ëª¨ë“œ: ì „ì•¡ TQQQ (í˜„ê¸ˆ ëŒ€ì‹  TQQQ ë³´ìœ )
                        // ì—¬ê¸°ì„œëŠ” cashUSD ë³€ìˆ˜ë¥¼ ì“°ì§€ ì•Šê³  TQQQ sharesë¥¼ ëŠ˜ë¦¼
                        shares.TQQQ += depositUSD / day.tqqq;
                    }
                }
            }

            // --- ì „ëµ íŠ¸ë¦¬ê±° ì²´í¬ ---
            if(currentStrat === 1) {
                // [ì „ëµ 1]
                if(mode === 'NORMAL' && mdd <= dropTrigger * -1) {
                    mode = 'ATTACK';
                    lockedATH = ath; // í•˜ë½ ì§ì „ ê³ ì  ì €ì¥
                    // QQQ ì „ëŸ‰ ë§¤ë„ -> TQQQ ë§¤ìˆ˜
                    let val = shares.QQQ * day.qqq;
                    shares.QQQ = 0;
                    shares.TQQQ = val / day.tqqq;
                    logs.push(`[${day.dateStr}] ğŸ“‰ ìŠ¤ìœ„ì¹­ ë°œë™ (MDD ${(mdd*100).toFixed(1)}%): QQQ -> TQQQ êµì²´`);
                } 
                else if(mode === 'ATTACK') {
                    // ìµì ˆ: ì§ì „ ê³ ì  ëŒ€ë¹„ 10% ìƒìŠ¹
                    let targetPrice = lockedATH * (1 + targetReturn);
                    if(day.qqq >= targetPrice) {
                        mode = 'NORMAL';
                        // TQQQ ë§¤ë„ -> QQQ ë§¤ìˆ˜
                        let val = shares.TQQQ * day.tqqq;
                        shares.TQQQ = 0;
                        shares.QQQ = val / day.qqq;
                        logs.push(`[${day.dateStr}] ğŸ“ˆ ëª©í‘œë‹¬ì„± (QQQ $${day.qqq.toFixed(2)}): TQQQ ìµì ˆ -> QQQ ë³µê·€`);
                    }
                }
            } else {
                // [ì „ëµ 2]
                if(mode === 'NORMAL' && mdd <= dropTrigger * -1) {
                    mode = 'ATTACK';
                    lockedATH = ath;
                    // ë³´ìœ  í˜„ê¸ˆ ì „ì•¡ TQQQ ë§¤ìˆ˜ (QLD ìœ ì§€)
                    if(cashUSD > 0) {
                        shares.TQQQ = cashUSD / day.tqqq;
                        cashUSD = 0;
                        logs.push(`[${day.dateStr}] ğŸ“‰ ê³µê²©ì „í™˜ (MDD ${(mdd*100).toFixed(1)}%): í˜„ê¸ˆ -> TQQQ íˆ¬ì…`);
                    }
                } 
                else if(mode === 'ATTACK') {
                    let targetPrice = lockedATH * (1 + targetReturn);
                    if(day.qqq >= targetPrice) {
                        mode = 'NORMAL';
                        // TQQQ ë§¤ë„ -> í˜„ê¸ˆí™” & ë¦¬ë°¸ëŸ°ì‹± (QLD:Cash 1:1)
                        let tqqqVal = shares.TQQQ * day.tqqq;
                        let qldVal = shares.QLD * day.qld;
                        let total = tqqqVal + qldVal;
                        
                        shares.TQQQ = 0;
                        shares.QLD = (total * 0.5) / day.qld;
                        cashUSD = total * 0.5;
                        logs.push(`[${day.dateStr}] ğŸ“ˆ ëª©í‘œë‹¬ì„±: TQQQ ìµì ˆ ë° 5:5 ë¦¬ë°¸ëŸ°ì‹±`);
                    }
                }
            }

            // ìì‚° í‰ê°€ (KRW)
            let currentEquityUSD = (shares.QQQ * day.qqq) + (shares.TQQQ * day.tqqq) + (shares.QLD * day.qld) + cashUSD;
            let equityKRW = currentEquityUSD * exRate;
            history.push({ date: day.dateStr, val: equityKRW, p: totalPrincipalKRW });
        }

        // ê²°ê³¼ í‘œì‹œ
        const final = history[history.length-1];
        const profit = final.val - final.p;
        const yield = (profit / final.p) * 100;

        document.getElementById('resPrincipal').innerText = Math.round(final.p).toLocaleString() + " ì›";
        document.getElementById('resFinal').innerText = Math.round(final.val).toLocaleString() + " ì›";
        document.getElementById('resYield').innerText = yield.toFixed(2) + " %";
        document.getElementById('resFinal').style.color = yield >= 0 ? '#ef4444' : '#3b82f6';

        drawChart(history);
        
        // ë¡œê·¸ ì¶œë ¥ (ìµœê·¼ 100ê°œë§Œ í‘œì‹œí•˜ê±°ë‚˜ ìŠ¤í¬ë¡¤)
        const logHTML = logs.map(l => `<div class="log-item">${l}</div>`).join('');
        document.getElementById('logList').innerHTML = logHTML;
    }

    function drawChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        // ë°ì´í„° ìƒ˜í”Œë§ (ë„ˆë¬´ ë§ìœ¼ë©´ ë ‰ ê±¸ë¦¼)
        const step = Math.ceil(data.length / 1000) || 1;
        const sampled = data.filter((_, i) => i % step === 0);

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sampled.map(d => d.date),
                datasets: [
                    {
                        label: 'ìì‚° í‰ê°€ì•¡ (KRW)',
                        data: sampled.map(d => Math.round(d.val)),
                        borderColor: currentStrat===1 ? '#f59e0b' : '#10b981',
                        backgroundColor: currentStrat===1 ? '#f59e0b1a' : '#10b9811a',
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'íˆ¬ì ì›ê¸ˆ',
                        data: sampled.map(d => Math.round(d.p)),
                        borderColor: '#94a3b8',
                        borderWidth: 1,
                        borderDash: [5,5],
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { y: { beginAtZero: false } }
            }
        });
    }
</script>
</body>
</html>