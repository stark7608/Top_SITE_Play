<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Stock Averaging Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { background-color: #131722; color: #d1d4dc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; }
        .card { background-color: #1e222d; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .input-dark { background-color: #2a2e39; border: 1px solid #434651; color: #d1d4dc; }
        .input-dark:focus { border-color: #2962ff; outline: none; }
        .btn-primary { background-color: #2962ff; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #1e53e5; }
        .btn-secondary { background-color: #434651; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #5d606b; }
        /* í•œêµ­ì‹ í‘œê¸°: ìƒìŠ¹(Red), í•˜ë½(Blue) */
        .kr-up { color: #f23645; }
        .kr-down { color: #2962ff; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-white">ì£¼ì‹ ì¶”ê°€ë§¤ìˆ˜(ë¬¼íƒ€ê¸°) ì „ëµ ê³„ì‚°ê¸°</h1>
                <p class="text-sm text-gray-400">Trading Tool : 60MA vs 200MA Analysis</p>
            </div>
            <div class="text-xs text-gray-500 text-right">
                <p>Data Source: TradingView CSV</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Settings & Analysis -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- 1. File Upload -->
                <div class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-white">1. ë°ì´í„° ì—…ë¡œë“œ</h2>
                        <span id="uploadedFileName" class="text-xs font-bold text-[#2962ff]"></span>
                    </div>
                    
                    <p class="text-xs text-gray-400 mb-3">TradingView ì°¨íŠ¸ ë°ì´í„°(.csv)ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ìƒ˜í”Œì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                    
                    <!-- File Input -->
                    <input type="file" id="csvInput" accept=".csv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#2962ff] file:text-white hover:file:bg-[#1e53e5] cursor-pointer mb-3" tabindex="1"/>
                    
                    <!-- Sample Data Button -->
                    <button onclick="loadSampleData()" class="w-full py-2 px-4 rounded-full bg-[#434651] hover:bg-[#5d606b] text-sm text-white font-semibold transition flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‚´í´ë³´ê¸°
                    </button>

                    <div id="fileStatus" class="mt-2 text-sm text-gray-500">íŒŒì¼ ëŒ€ê¸° ì¤‘...</div>
                </div>

                <!-- 2. Current Position -->
                <div class="card p-5">
                    <h2 class="text-lg font-semibold mb-4 text-white">2. í˜„ì¬ ë³´ìœ  í˜„í™©</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">í˜„ì¬ ë³´ìœ  í‰ê· ë‹¨ê°€</label>
                            <input type="text" inputmode="decimal" id="currentAvgPrice" class="input-dark w-full p-2 rounded text-right font-mono" placeholder="0" oninput="formatCurrency(this); calculateTotalInvested()" tabindex="2">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰</label>
                            <input type="text" inputmode="decimal" id="currentQty" class="input-dark w-full p-2 rounded text-right font-mono" placeholder="0" oninput="formatCurrency(this); calculateTotalInvested()" tabindex="3">
                        </div>
                        <div class="pt-2 border-t border-gray-700">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">ì´ ë§¤ìˆ˜ ê¸ˆì•¡</span>
                                <span id="totalInvested" class="font-mono text-white">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Technical Analysis Result -->
                <div class="card p-5 border-l-4 border-gray-600" id="analysisCard">
                    <h2 class="text-lg font-semibold mb-2 text-white">3. ê¸°ìˆ ì  ë¶„ì„ (200ì¼ ê¸°ì¤€)</h2>
                    <div id="analysisContent" class="text-sm text-gray-400">
                        ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ 60ì¼/200ì¼ ì´í‰ì„  ë° RSI ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>

            </div>

            <!-- Right Column: Chart & Simulation -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Chart Area -->
                <div class="card p-5">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex flex-col">
                            <h2 class="text-lg font-semibold text-white">ì¶”ì„¸ ë° ì§€ì§€ì €í•­</h2>
                            <span id="chartSubtitle" class="text-xs text-gray-500 font-normal"></span>
                        </div>
                        <span id="currentMarketPrice" class="text-xl font-bold font-mono kr-up"></span>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="flex justify-center gap-4 mt-2 text-xs text-gray-400">
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-[#f23645] mr-1"></span>200MA (ì¥ê¸°)</span>
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-[#ff9800] mr-1"></span>60MA (ìˆ˜ê¸‰)</span>
                        <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-[#089981] mr-1"></span>Bollinger (ë‹¨ê¸°)</span>
                    </div>
                </div>

                <!-- 4. Strategy & Calculator -->
                <div class="card p-5">
                    <h2 class="text-lg font-semibold mb-4 text-white">4. ì¶”ê°€ ë§¤ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ (ë¬¼íƒ€ê¸°)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Inputs -->
                        <div class="space-y-4">
                            <div class="bg-[#2a2e39] p-3 rounded border border-gray-600">
                                <label class="block text-xs text-gray-400 mb-1">ì¶”ì²œ ë§¤ìˆ˜ ê°€ê²© (ì„ íƒ ê°€ëŠ¥)</label>
                                <div class="flex gap-2">
                                    <input type="text" inputmode="decimal" id="newBuyPrice" class="input-dark w-full p-2 rounded font-bold text-[#2962ff] text-right font-mono" placeholder="0" oninput="formatCurrency(this); calculate()" tabindex="4">
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="applySuggestion('bollinger')" class="flex-1 bg-gray-700 hover:bg-[#089981] text-[10px] py-1 rounded text-white transition">ë‹¨ê¸° ì¶”ì²œê°€</button>
                                    <button onclick="applySuggestion('support')" class="flex-1 bg-gray-700 hover:bg-[#1e53e5] text-[10px] py-1 rounded text-white transition">ì¥ê¸° ì¶”ì²œê°€</button>
                                </div>
                            </div>

                            <div class="bg-[#2a2e39] p-3 rounded border border-gray-600">
                                <label class="block text-xs text-gray-400 mb-1">ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰ (ìê¸ˆ ê´€ë¦¬)</label>
                                <div class="flex gap-2">
                                    <input type="text" inputmode="decimal" id="newBuyQty" class="input-dark w-full p-2 rounded text-right font-mono" placeholder="0" oninput="formatCurrency(this); calculate()" tabindex="5">
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="applyQuantity('half')" class="flex-1 bg-gray-700 hover:bg-[#ff9800] text-[10px] py-1 rounded text-white transition">ë‹¨ê¸° (50% ì¶”ê°€)</button>
                                    <button onclick="applyQuantity('full')" class="flex-1 bg-gray-700 hover:bg-[#f23645] text-[10px] py-1 rounded text-white transition">ì¥ê¸° (100% ì¶”ê°€)</button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">ë˜ëŠ” ì¶”ê°€ íˆ¬ì ê¸ˆì•¡</label>
                                <input type="text" inputmode="decimal" id="newBuyAmount" class="input-dark w-full p-2 rounded text-right font-mono" placeholder="0" oninput="formatCurrency(this); calculateByAmount()" tabindex="6">
                            </div>
                        </div>

                        <!-- Results -->
                        <div class="bg-[#131722] p-4 rounded border border-gray-700 flex flex-col justify-center space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400 text-sm">ë³€ê²½ í›„ í‰ê· ë‹¨ê°€</span>
                                <span id="finalAvgPrice" class="text-xl font-bold text-yellow-400 font-mono">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400 text-sm">ì´ ë³´ìœ  ìˆ˜ëŸ‰</span>
                                <span id="finalQty" class="text-lg text-white font-mono">0</span>
                            </div>
                            <div class="h-px bg-gray-700 my-2"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400 text-sm">í˜„ì¬ê°€ ëŒ€ë¹„ ì†ìµë¥  (ì˜ˆìƒ)</span>
                                <span id="pnlPercent" class="text-lg font-bold font-mono">0.00%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400 text-sm">ì†ìµë¶„ê¸°ì ê¹Œì§€</span>
                                <span id="breakEvenGap" class="text-sm text-gray-500 font-mono">0% ìƒìŠ¹ í•„ìš”</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Footer / Disclaimer (ìš”ì²­ì‚¬í•­ C) -->
        <footer class="mt-8 pt-4 border-t border-gray-800 text-center text-xs text-gray-600">
            <p>âš ï¸ ë³¸ ê³„ì‚°ê¸°ì˜ ë¶„ì„ ê²°ê³¼ëŠ” ê¸°ìˆ ì  ì§€í‘œì— ê¸°ë°˜í•œ ì°¸ê³ ìš© ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤.</p>
            <p>íˆ¬ìì˜ ì±…ì„ì€ ì „ì ìœ¼ë¡œ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìœ¼ë©°, ì‹œì¥ ìƒí™©ì— ë”°ë¼ ì‹¤ì œ ê²°ê³¼ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </footer>
    </div>

    <script>
        // Global Data
        let chartData = []; 
        let ma200Value = 0;
        let ma60Value = 0; 
        let supportPrice200 = 0; 
        let bollingerLower = 0; 
        let rsiValue = 0;       
        let chartInstance = null;

        // --- Sample Data Generator (Mimics Samsung Electronics Data) ---
        // Generates data from 2025.01.01 to 2025.12.11
        function generateSampleData() {
            const data = [];
            let price = 72000;
            
            // ì‹œì‘ì¼: 2025ë…„ 1ì›” 1ì¼
            const currentDate = new Date('2025-01-01T09:00:00');
            // ì¢…ë£Œì¼: 2025ë…„ 12ì›” 11ì¼
            const endDate = new Date('2025-12-11T15:30:00');

            while (currentDate <= endDate) {
                // ì£¼ë§(ì¼ìš”ì¼:0, í† ìš”ì¼:6)ì€ ì œì™¸í•˜ê³  í‰ì¼ë§Œ ë°ì´í„° ìƒì„± (ì°¨íŠ¸ í’ˆì§ˆ í–¥ìƒ)
                const day = currentDate.getDay();
                if (day !== 0 && day !== 6) {
                    const timeStr = Math.floor(currentDate.getTime() / 1000).toString();

                    // Random walk logic
                    const change = (Math.random() - 0.5) * 1500; 
                    price += change;
                    
                    // Ensure realistic range 50k - 95k
                    if(price < 52000) price += 1000;
                    if(price > 95000) price -= 1000;

                    const close = Math.round(price);
                    const low = Math.round(price - (Math.random() * 1000));
                    // open, highë„ ê°„ë‹¨íˆ ìƒì„±
                    const open = Math.round(price + (Math.random() * 500) - 250);
                    const high = Math.round(Math.max(open, close) + (Math.random() * 500));
                    
                    // Format: time, open, high, low, close
                    data.push(`${timeStr},${open},${high},${low},${close}`);
                }
                
                // ë‹¤ìŒ ë‚ ë¡œ ì´ë™
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return "time,open,high,low,close\n" + data.join("\n");
        }

        const SAMPLE_DATA_CSV = generateSampleData();

        // --- Helper: Format Number with Commas ---
        function formatCurrency(input) {
            let value = input.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            if (parts.length > 1) {
                input.value = parts[0] + '.' + parts.slice(1).join('');
            } else {
                input.value = parts[0];
            }
        }

        function parseNumber(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        // --- File & Sample Loading ---
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Display filename
            document.getElementById('uploadedFileName').innerText = "[" + file.name + "]";
            document.getElementById('chartSubtitle').innerText = file.name;
            document.getElementById('fileStatus').innerText = "íŒŒì¼ ë¶„ì„ ì¤‘...";
            
            const reader = new FileReader();
            reader.onload = function(event) { parseCSV(event.target.result); };
            reader.readAsText(file);
        });

        function loadSampleData() {
            // Reset file input
            document.getElementById('csvInput').value = '';
            
            // Set Sample UI
            document.getElementById('uploadedFileName').innerText = "[ìƒ˜í”Œ ë°ì´í„°]";
            document.getElementById('chartSubtitle').innerText = "[ìƒ˜í”Œ ë°ì´í„°: Samsung Elec Sim (2025.01.01 ~ 2025.12.11)]";
            document.getElementById('fileStatus').innerText = "ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ ì¤‘...";
            
            // Load
            parseCSV(SAMPLE_DATA_CSV);
        }

        function parseCSV(csvText) {
            // ìš”ì²­ì‚¬í•­ A: CSV ì¤„ë°”ê¿ˆ í˜¸í™˜ì„± ê°œì„  (ìœˆë„ìš° \r\n, ë§¥/ë¦¬ëˆ…ìŠ¤ \n ëª¨ë‘ ì§€ì›)
            const lines = csvText.split(/\r?\n/);
            const data = [];
            let startIndex = isNaN(lines[0][0]) ? 1 : 0;

            for (let i = startIndex; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < 5) continue;
                const close = parseFloat(row[4]); 
                const low = parseFloat(row[3]);   
                const time = row[0];
                
                // Unix timestamp conversion for display if needed, but we use index mostly
                if (!isNaN(close)) data.push({ time, close, low });
            }

            if (data.length < 2) { alert("ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }

            chartData = data;
            document.getElementById('fileStatus').innerText = `ë¡œë“œ ì™„ë£Œ: ${data.length}ê°œ ìº”ë“¤`;
            
            const lastPrice = chartData[chartData.length - 1].close;
            document.getElementById('currentMarketPrice').innerText = lastPrice.toLocaleString();
            document.getElementById('currentMarketPrice').dataset.price = lastPrice;

            calculateIndicators(); 
            runAnalysis();
            drawChart();
        }

        function calculateIndicators() {
            if (chartData.length < 20) return;

            // 1. RSI (14)
            let gains = 0, losses = 0, period = 14;
            // Simple SMA RSI for initial calculation
            // Better: Wilder's Smoothing but simple Avg Gain/Loss is okay for basic check
            for (let i = chartData.length - period; i < chartData.length; i++) {
                const change = chartData[i].close - chartData[i-1].close;
                if (change >= 0) gains += change; else losses -= change;
            }
            let rs = (gains / period) / (losses / period);
            if (losses === 0) rsiValue = 100;
            else rsiValue = 100 - (100 / (1 + rs));

            // 2. Bollinger (20, 2)
            const recent20 = chartData.slice(-20);
            const sma20 = recent20.reduce((a, c) => a + c.close, 0) / 20;
            const sqDiff = recent20.map(d => Math.pow(d.close - sma20, 2)).reduce((a, b) => a + b) / 20;
            bollingerLower = sma20 - (2 * Math.sqrt(sqDiff));
            
            // 3. MA 200 & MA 60 & Support 200
            if (chartData.length >= 200) {
                const recent200 = chartData.slice(-200);
                ma200Value = recent200.reduce((acc, cur) => acc + cur.close, 0) / 200;
                supportPrice200 = Math.min(...recent200.map(d => d.low)); 
            } else {
                // Fallback if data is short
                ma200Value = chartData.reduce((acc, cur) => acc + cur.close, 0) / chartData.length;
                supportPrice200 = Math.min(...chartData.map(d => d.low));
            }

            if (chartData.length >= 60) {
                const recent60 = chartData.slice(-60);
                ma60Value = recent60.reduce((acc, cur) => acc + cur.close, 0) / 60;
            } else {
                ma60Value = chartData.reduce((acc, cur) => acc + cur.close, 0) / chartData.length;
            }
        }

        function runAnalysis() {
            const lastPrice = chartData[chartData.length - 1].close;
            
            // Trend Analysis
            const isBullish200 = lastPrice > ma200Value;
            const isBullish60 = lastPrice > ma60Value;
            let trendText = "";
            
            if (isBullish200 && isBullish60) trendText = "ì™„ì „ ì •ë°°ì—´ (ê°•í•œ ìƒìŠ¹)";
            else if (!isBullish200 && !isBullish60) trendText = "ì™„ì „ ì—­ë°°ì—´ (ê°•í•œ í•˜ë½)";
            else if (ma60Value > ma200Value) trendText = "ê³¨ë“ í¬ë¡œìŠ¤ êµ¬ê°„ (ì¡°ì • ì¤‘)";
            else trendText = "ë°ë“œí¬ë¡œìŠ¤ êµ¬ê°„ (ë°˜ë“± ì‹œë„)";

            // RSI Status
            let rsiStatus = rsiValue <= 30 ? "ê³¼ë§¤ë„ (ê¸°íšŒ)" : (rsiValue >= 70 ? "ê³¼ë§¤ìˆ˜ (ìœ„í—˜)" : "ì¤‘ë¦½");
            let rsiColor = rsiValue <= 30 ? "text-yellow-400 font-bold" : (rsiValue >= 70 ? "text-red-500" : "text-gray-300");

            // Suggestion
            let suggestion = "";
            let cardColor = "";

            if (rsiValue <= 35) {
                cardColor = "#089981"; 
                suggestion = "RSI ê³¼ë§¤ë„ êµ¬ê°„ì…ë‹ˆë‹¤. ë‹¨ê¸° ë°˜ë“±ì„ ë…¸ë¦¬ëŠ” 'ë³¼ë¦°ì € í•˜ë‹¨' ë§¤ìˆ˜ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.";
            } else if (!isBullish200) {
                cardColor = "#2962ff"; 
                suggestion = "200ì¼ì„  ì•„ë˜ í•˜ë½ì¥ì…ë‹ˆë‹¤. ë³´ìˆ˜ì ìœ¼ë¡œ '200ì¼ ìµœì €ê°€(ì¥ê¸° ì§€ì§€)'ì—ì„œ ë¬¼íƒ€ê¸°ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.";
            } else {
                cardColor = "#f23645"; 
                suggestion = "ìƒìŠ¹ ì¶”ì„¸ì…ë‹ˆë‹¤. ëˆŒë¦¼ëª©(60ì¼ì„  ë˜ëŠ” ë³¼ë¦°ì € í•˜ë‹¨) ë§¤ìˆ˜ê°€ ìœ íš¨í•©ë‹ˆë‹¤.";
            }
            
            document.getElementById('analysisCard').style.borderColor = cardColor;
            document.getElementById('analysisContent').innerHTML = `
                <ul class="space-y-2">
                    <li class="flex justify-between">
                        <span>â€¢ í˜„ì¬ê°€:</span> 
                        <span class="font-mono text-white">${lastPrice.toLocaleString()}</span>
                    </li>
                    <li class="flex justify-between">
                        <span>â€¢ ì¶”ì„¸ (200/60):</span> 
                        <span class="text-white text-xs text-right">${trendText}</span>
                    </li>
                    <li class="flex justify-between">
                        <span>â€¢ 200ì¼ì„  / 60ì¼ì„ :</span> 
                        <span class="text-xs text-gray-400 text-right">${Math.round(ma200Value).toLocaleString()} / ${Math.round(ma60Value).toLocaleString()}</span>
                    </li>
                    <li class="flex justify-between">
                        <span>â€¢ RSI (14):</span> 
                        <span class="${rsiColor}">${rsiValue.toFixed(2)} (${rsiStatus})</span>
                    </li>
                    <li class="mt-3 text-sm text-white border-t border-gray-600 pt-2 bg-[#2a2e39] p-2 rounded">
                        ğŸ’¡ <strong>ì „ëµ:</strong> ${suggestion}
                    </li>
                </ul>
            `;
        }

        function drawChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            // Simple labels (just index or date approximation)
            const labels = chartData.map((d, i) => {
                 // Convert timestamp if available, else use index
                 if (d.time.length > 8) {
                     const date = new Date(parseInt(d.time) * 1000);
                     return date.toISOString().slice(0,10);
                 }
                 return i;
            });
            const prices = chartData.map(d => d.close);

            const ma200Data = [];
            const ma60Data = []; 
            const bBandData = [];
            
            // Loop for MAs
            for (let i = 0; i < chartData.length; i++) {
                // 200 MA
                if (i < 199) ma200Data.push(null);
                else {
                    const slice = chartData.slice(i - 199, i + 1);
                    ma200Data.push(slice.reduce((a, b) => a + b.close, 0) / 200);
                }
                // 60 MA
                if (i < 59) ma60Data.push(null);
                else {
                    const slice = chartData.slice(i - 59, i + 1);
                    ma60Data.push(slice.reduce((a, b) => a + b.close, 0) / 60);
                }
                // Bollinger
                if (i < 19) bBandData.push(null);
                else {
                    const slice = chartData.slice(i - 19, i + 1);
                    const avg = slice.reduce((a, b) => a + b.close, 0) / 20;
                    const sd = Math.sqrt(slice.map(d => Math.pow(d.close - avg, 2)).reduce((a, b) => a + b) / 20);
                    bBandData.push(avg - 2 * sd);
                }
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Price', data: prices, borderColor: '#d1d4dc', borderWidth: 1, pointRadius: 0, tension: 0.1 },
                        { label: '200 MA', data: ma200Data, borderColor: '#f23645', borderWidth: 2, pointRadius: 0, fill: false },
                        { label: '60 MA', data: ma60Data, borderColor: '#ff9800', borderWidth: 1.5, pointRadius: 0, fill: false },
                        { label: 'Bollinger Low', data: bBandData, borderColor: '#089981', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: { 
                        // ìš”ì²­ì‚¬í•­ B: ëª¨ë°”ì¼ ì°¨íŠ¸ ê°€ë…ì„± (Xì¶• ë¼ë²¨ ì œí•œ)
                        x: { 
                            display: true, 
                            grid: { display: false },
                            ticks: {
                                color: '#888',
                                maxTicksLimit: 6, // Xì¶• ë¼ë²¨ ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ í‘œì‹œ (ëª¨ë°”ì¼ ìµœì í™”)
                                maxRotation: 0
                            }
                        }, 
                        y: { 
                            grid: { color: '#2a2e39' }, 
                            ticks: { color: '#888' } 
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function applySuggestion(type) {
            let price = 0;
            if (type === 'bollinger') {
                if (bollingerLower <= 0) return alert("ë¶„ì„ ë°ì´í„° ë¶€ì¡±");
                price = Math.round(bollingerLower);
            } else if (type === 'support') {
                if (supportPrice200 <= 0) return alert("ë¶„ì„ ë°ì´í„° ë¶€ì¡±");
                price = supportPrice200;
            }

            const input = document.getElementById('newBuyPrice');
            input.value = price.toLocaleString(); 
            
            input.style.backgroundColor = "#1e53e5";
            setTimeout(() => input.style.backgroundColor = "#2a2e39", 500);
            calculate();
        }

        // New Function: Apply Recommended Quantity Logic
        function applyQuantity(type) {
            // í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰ ê°€ì ¸ì˜¤ê¸°
            const currentQty = parseNumber(document.getElementById('currentQty').value);
            
            if (currentQty <= 0) {
                alert("í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                document.getElementById('currentQty').focus();
                return;
            }

            let newQty = 0;

            if (type === 'half') {
                // ë‹¨ê¸°: ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ìœ„í•´ ë³´ìœ  ìˆ˜ëŸ‰ì˜ 50%ë§Œ ì¶”ê°€ (ê°€ë³ê²Œ í‰ë‹¨ ì¡°ì ˆ)
                newQty = Math.floor(currentQty * 0.5);
            } else if (type === 'full') {
                // ì¥ê¸°: í™•ì‹¤í•œ ì§€ì§€ì„ ì—ì„œ ìŠ¹ë¶€ë¥¼ ë³´ê¸° ìœ„í•´ 1:1 ë¹„ìœ¨ë¡œ ì¶”ê°€ (í™•ì‹¤í•œ í‰ë‹¨ ì¸í•˜)
                newQty = Math.floor(currentQty * 1.0);
            }

            // ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸ (ì½¤ë§ˆ í¬ë§·íŒ… í¬í•¨)
            const input = document.getElementById('newBuyQty');
            input.value = newQty.toLocaleString();
            
            // ì‹œê°ì  í”¼ë“œë°±
            input.style.backgroundColor = "#1e53e5";
            setTimeout(() => input.style.backgroundColor = "#2a2e39", 500);

            // ê³„ì‚° ì‹¤í–‰
            calculate();
        }

        function calculateTotalInvested() {
            const p = parseNumber(document.getElementById('currentAvgPrice').value);
            const q = parseNumber(document.getElementById('currentQty').value);
            document.getElementById('totalInvested').innerText = (p * q).toLocaleString();
            calculate(); 
        }

        function calculateByAmount() {
            const amount = parseNumber(document.getElementById('newBuyAmount').value);
            const price = parseNumber(document.getElementById('newBuyPrice').value);
            
            if (price > 0) {
                const qty = amount / price;
                document.getElementById('newBuyQty').value = qty.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                calculate(true); 
            }
        }

        function calculate(skipAmountCalc = false) {
            const oldPrice = parseNumber(document.getElementById('currentAvgPrice').value);
            const oldQty = parseNumber(document.getElementById('currentQty').value);
            const newPrice = parseNumber(document.getElementById('newBuyPrice').value);
            const newQty = parseNumber(document.getElementById('newBuyQty').value);

            if (!skipAmountCalc && newPrice > 0) {
                const amount = Math.floor(newPrice * newQty);
                document.getElementById('newBuyAmount').value = amount.toLocaleString();
            }
            if (oldQty === 0 && newQty === 0) return;

            const totalQty = oldQty + newQty;
            const totalAmount = (oldPrice * oldQty) + (newPrice * newQty);
            const finalAvg = totalAmount / totalQty;

            document.getElementById('finalAvgPrice').innerText = Math.round(finalAvg).toLocaleString();
            document.getElementById('finalQty').innerText = totalQty.toLocaleString();

            let currentMarketPrice = parseFloat(document.getElementById('currentMarketPrice').dataset.price);
            if (!currentMarketPrice || isNaN(currentMarketPrice)) currentMarketPrice = newPrice;

            const pnlRate = ((currentMarketPrice - finalAvg) / finalAvg) * 100;
            const pnlEl = document.getElementById('pnlPercent');
            const gap = ((finalAvg - currentMarketPrice) / currentMarketPrice) * 100;
            const gapEl = document.getElementById('breakEvenGap');

            if (!isNaN(pnlRate) && isFinite(pnlRate)) {
                pnlEl.innerText = pnlRate.toFixed(2) + "%";
                if (pnlRate > 0) {
                    pnlEl.className = "text-lg font-bold font-mono kr-up"; 
                    pnlEl.innerText = "+" + pnlEl.innerText;
                    gapEl.innerText = "ì´ë¯¸ ìˆ˜ìµ êµ¬ê°„ì…ë‹ˆë‹¤.";
                    gapEl.className = "text-sm kr-up font-mono";
                } else {
                    pnlEl.className = "text-lg font-bold font-mono kr-down"; 
                    gapEl.innerText = `${gap.toFixed(2)}% ìƒìŠ¹ ì‹œ ì›ê¸ˆ íšŒë³µ`;
                    gapEl.className = "text-sm text-gray-400 font-mono";
                }
            }
        }
    </script>
</body>
</html>